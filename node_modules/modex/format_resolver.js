var supportedFormats = require('./views').renderers;

exports = module.exports = function (){
  return function (req, res, next) {
    var format = req.query.format;
    if (format) { // format is explicitly specified in the query string
      if (format in supportedFormats) req.format = format;
      else req.format = 'unknown';
    } else { // no format is specified, use the http "accept" header
      req.accepted.some(function(token){
        req.format = 'default';
        for (format in supportedFormats) {
          if (token.value.indexOf(format) > -1) {
            req.format = format;
            return true;
          }
        }
      });
      if (req.format === 'default' && req.accepts('html')) {
        req.format = 'html';
      }      
    }
    //console.log(req.accepted);
    next();
  };
};