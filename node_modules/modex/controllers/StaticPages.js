"use strict";

var utils = require('../utils');
var path = require('path');
var eachFileInDir = utils.eachFileInDir;
var util = require('util');

var StaticPages = module.exports = function StaticPages(mod, pathToDir, routeName) {
  if (typeof routeName !== 'string') routeName = '';
  require('./Base').call(this, {name:routeName});
  //var pages = {};
  var fullpath = path.resolve(mod.path, pathToDir);
  var self = this;
  eachFileInDir(fullpath, function(name, fp) {
    var ext = path.extname(name);
    if (ext in {'.html':0, '.htm':0, '.ejs':0}) {
      name = name.slice(0, -ext.length);
      //pages[name] = fp;
      self[name] = function(req, res){
        render(self, name, fp, res);
      };
    }
  });  
};

function render(controller, page, pagePath, res) {
  var options = {};
  options.title = page;
  options._controller = controller;
  options._actionName = page;
  options._view = pagePath;
  options._layout = controller._layout || ['layout'];
  res.respond(options);
}

function renderIndex(controller, page, base, children, res) {
  var options = {};
  options.title = page;
  options._controller = controller;
  options._actionName = page;
  options._view = '[default]';
  options._layout = controller._layout || ['layout'];
  var content = '';
  children.forEach(function(child) {
    content += util.format('<a href="%s">%s</a>', base + '/' + child, child);
  });
  res.locals._.setPartial(content);
  res.render(options._layout, options);
}